# PD120 Mode - Technical Specification

## Overview

PD120 is a high-resolution SSTV mode designed for quality image transmission. It uses sequential RGB encoding (non-interlaced) with Y, R-Y, and B-Y components transmitted in each scan line. This mode is commonly used for ISS SSTV events.

## Image Specifications

| Parameter | Value |
|-----------|-------|
| **Resolution** | 640×496 pixels |
| **Aspect Ratio** | ~1.29:1 (approximately 4:3) |
| **Total Lines** | 496 (sequential, non-interlaced) |
| **Line Time** | ~496.628ms per scan line |
| **Total Duration** | ~4 minutes 6 seconds |
| **VIS Code** | 95 |

## Frequency Mapping

| Signal | Frequency | Purpose |
|--------|-----------|---------|
| **Sync Pulse** | 1200 Hz | Line boundary marker (20ms) |
| **Black Level** | 1500 Hz | Minimum brightness |
| **Gray Level** | 1900 Hz | Center frequency |
| **White Level** | 2300 Hz | Maximum brightness |

**Frequency Range**: 800 Hz (1500-2300 Hz) represents 0-255 pixel values

## Scan Line Structure

```
Total: 496.628ms per line

|--20ms--|--2.08ms--|------121.6ms------|--4.862ms--|1.504ms|------121.6ms------|--4.862ms--|1.504ms|------121.6ms------|
  Sync    S.Porch    Luminance (Y)       Separator   Porch   Red Diff (R-Y)     Separator   Porch   Blue Diff (B-Y)
 1200Hz   1500Hz     640 pixels          1500Hz              640 pixels         1500Hz              640 pixels
                     1500-2300Hz                             1500-2300Hz                            1500-2300Hz
```

### Timing Breakdown

1. **Sync Pulse**: 20ms @ 1200 Hz
   - Purpose: Line boundary detection
   - Longer than Robot36 (9ms) for better reliability
   - Used to identify start of new line

2. **Sync Porch**: 2.08ms @ 1500 Hz
   - Purpose: Transition period after sync
   - Stabilization time for receiver

3. **Y Channel (Luminance)**: 121.6ms
   - 640 pixels of brightness information
   - Frequency range: 1500-2300 Hz (black to white)
   - Transmitted first in every line

4. **First Separator**: 4.862ms @ 1500 Hz
   - Fixed frequency separator between Y and R-Y
   - Not used for line type detection (unlike Robot36)

5. **First Porch**: 1.504ms
   - Transition period before R-Y channel

6. **R-Y Channel (Red Difference)**: 121.6ms
   - 640 pixels of red color difference
   - Represents (R - Y) component
   - Centered at 128 (1900 Hz)

7. **Second Separator**: 4.862ms @ 1500 Hz
   - Fixed frequency separator between R-Y and B-Y

8. **Second Porch**: 1.504ms
   - Transition period before B-Y channel

9. **B-Y Channel (Blue Difference)**: 121.6ms
   - 640 pixels of blue color difference
   - Represents (B - Y) component
   - Centered at 128 (1900 Hz)

## Color Encoding: Sequential RGB

Unlike Robot36's interlaced format, PD120 transmits all color information in each scan line.

### Sequential Strategy

```
Line 0: Y₀[640] + (R-Y)₀[640] + (B-Y)₀[640]  → RGB row 0
Line 1: Y₁[640] + (R-Y)₁[640] + (B-Y)₁[640]  → RGB row 1
Line 2: Y₂[640] + (R-Y)₂[640] + (B-Y)₂[640]  → RGB row 2
...
Line 495: Y₄₉₅[640] + (R-Y)₄₉₅[640] + (B-Y)₄₉₅[640]  → RGB row 495
```

### Advantages of Sequential Encoding

1. **No interlacing artifacts**: Each line is independent
2. **Better vertical resolution**: Full resolution without line pairing
3. **Simpler decoding**: Direct YUV→RGB conversion per line
4. **More robust**: Line errors don't affect neighboring lines

### Disadvantages

1. **Longer transmission time**: ~4 minutes vs 36 seconds for Robot36
2. **Larger bandwidth requirements**: More data per line
3. **More susceptible to fading**: Long transmission increases chance of interference

## YUV to RGB Conversion (ITU-R BT.601)

PD120 uses the same color space as Robot36, but all components are available per line.

```typescript
// Input:
//   Y:  Luminance (0-255)
//   RY: R-Y color difference (0-255, centered at 128)
//   BY: B-Y color difference (0-255, centered at 128)

// Convert to difference signals
const ryDiff = RY - 128;  // -128 to +127
const byDiff = BY - 128;  // -128 to +127

// ITU-R BT.601 conversion
R = Y + 1.402 × ryDiff
G = Y - 0.344136 × byDiff - 0.714136 × ryDiff
B = Y + 1.772 × byDiff

// Clamp to valid range
R = clamp(R, 0, 255)
G = clamp(G, 0, 255)
B = clamp(B, 0, 255)
```

### Mathematical Derivation

The coefficients come from the ITU-R BT.601 standard:

```
U = B - Y = 0.564 × (B - Y)  [normalized]
V = R - Y = 0.713 × (R - Y)  [normalized]

Inverse transformation:
R = Y + V / 0.713 = Y + 1.402 × V
B = Y + U / 0.564 = Y + 1.772 × U
G = (Y - 0.299×R - 0.114×B) / 0.587
  = Y - 0.344136×U - 0.714136×V
```

## Noise Reduction Techniques

PD120 decoding implements several noise reduction strategies to improve image quality:

### 1. Median Filtering (Chroma Channels)

A 5-pixel median filter is applied to R-Y and B-Y chroma channels:

```typescript
// For each pixel position
const window = [chroma[x-2], chroma[x-1], chroma[x], chroma[x+1], chroma[x+2]];
window.sort((a, b) => a - b);
filteredChroma[x] = window[2];  // Median value
```

**Benefits:**
- Removes impulse noise (spikes) in color data
- Preserves edges better than averaging
- Reduces color artifacts and speckles

### 2. Chroma Desaturation

Reduces color intensity by 30% to suppress color noise:

```typescript
const CHROMA_REDUCTION = 0.7;
const ryReduced = 128 + (ry - 128) * CHROMA_REDUCTION;
const byReduced = 128 + (by - 128) * CHROMA_REDUCTION;
```

**Benefits:**
- Suppresses random color variations
- Maintains color accuracy while reducing noise
- Prevents oversaturation from signal noise

### 3. Bidirectional Low-Pass Filtering

Applied to all channels before sampling:

```typescript
// Forward pass
for (i = start; i < end; i++) {
  filtered[i] = EMA.average(samples[i]);
}

// Backward pass
EMA.reset();
for (i = end - 1; i >= start; i--) {
  filtered[i] = EMA.average(filtered[i]);
}
```

**Benefits:**
- Smooths high-frequency noise
- Zero-phase distortion (forward + backward)
- Preserves horizontal detail

## Signal Processing Pipeline

### 1. Sync Detection
- Monitor for 1200 Hz tone
- Measure pulse width (must be 20ms ±2ms)
- Calculate frequency offset for calibration
- **Note**: 20ms pulses distinguish PD modes from Robot36 (9ms)

### 2. Line Extraction
- Extract audio samples between consecutive sync pulses
- Should contain ~497ms of audio data
- Pass to PD120 line decoder

### 3. Bidirectional Filtering
```typescript
// Forward pass (left to right)
for (i = yStart; i < endSamples; i++) {
  filtered[i] = EMA.average(samples[i]);
}

// Backward pass (right to left)
EMA.reset();
for (i = endSamples - 1; i >= yStart; i--) {
  filtered[i] = freqToLevel(EMA.average(filtered[i]), freqOffset);
}
```

### 4. Channel Sampling

Each channel (Y, R-Y, B-Y) is sampled independently:

```typescript
// Sample 640 pixels from 121.6ms Y channel
for (x = 0; x < 640; x++) {
  sampleIndex = yStart + (x * ySamples) / 640;
  Y[x] = frequencyToLevel(filtered[sampleIndex]) * 255;
}

// Sample 640 pixels from 121.6ms R-Y channel
for (x = 0; x < 640; x++) {
  sampleIndex = ryStart + (x * rySamples) / 640;
  RY[x] = frequencyToLevel(filtered[sampleIndex]) * 255;
}

// Sample 640 pixels from 121.6ms B-Y channel
for (x = 0; x < 640; x++) {
  sampleIndex = byStart + (x * bySamples) / 640;
  BY[x] = frequencyToLevel(filtered[sampleIndex]) * 255;
}
```

### 5. RGB Conversion

For each pixel position x (0-639):

```typescript
const y = Y[x];
const ry = RY[x];
const by = BY[x];

// Convert to RGB
const rgb = yuv2rgb(y, ry, by);

// Store in image buffer
pixels[x * 4 + 0] = rgb.r;
pixels[x * 4 + 1] = rgb.g;
pixels[x * 4 + 2] = rgb.b;
pixels[x * 4 + 3] = 255;  // Alpha
```

## Implementation Notes

### Buffer Size Requirements

PD120 requires larger buffers than Robot36:
- Minimum buffer: 7 seconds (sufficient for 497ms lines + margin)
- Audio buffer: ~336,000 samples @ 48kHz or ~309,000 @ 44.1kHz
- Image buffer: 640 × 496 × 4 bytes = 1,269,760 bytes (~1.2 MB)

### Sample Rate Handling
- Supports 44.1 kHz and 48 kHz sample rates
- All timing calculations scale proportionally
- Higher sample rate provides better horizontal resolution

### Frequency Calibration
- Track frequency offset from sync pulse detection
- Apply offset to all channels (Y, R-Y, B-Y)
- Typical offset: ±50 Hz due to oscillator drift

### Error Handling
- Validate line length (should be ~497ms ±5%)
- Check sync pulse width (must be 20ms, not 9ms)
- Skip lines with invalid timing
- Continue decoding even if some lines fail

## Performance Characteristics

| Metric | Value |
|--------|-------|
| **Processing Time** | Real-time (~4 minutes) |
| **Memory Usage** | ~55 MB (buffers + image) |
| **CPU Usage** | 8-15% (single core) |
| **Minimum SNR** | 18 dB for reliable sync |
| **Data Rate** | ~4.3 kbps (640×496 in 246s) |

## Common Issues & Solutions

### Issue: Purple/Red Color Cast
**Cause**: Incorrect YUV coefficients or wrong channel order
**Solution**: Verify using ITU-R BT.601 with coefficients:
- R: Y + 1.402 × (R-Y)
- G: Y - 0.344136 × (B-Y) - 0.714136 × (R-Y)
- B: Y + 1.772 × (B-Y)

### Issue: Image Only Fills Half Canvas
**Cause**: Not all 496 lines being decoded or displayed
**Solution**:
- Verify decoder processes all 496 lines (not stopping at 240)
- Check canvas height is set to 496
- Ensure line counter increments correctly
- Validate sync pulse detection for 20ms (not 9ms)

### Issue: Horizontal Color Banding
**Cause**: Insufficient filtering or sampling errors
**Solution**:
- Apply bidirectional EMA filtering
- Verify correct channel timing (Y, R-Y, B-Y each 121.6ms)
- Check separator/porch positions

### Issue: Vertical Lines or Noise
**Cause**: Sync detection errors or buffer wraparound issues
**Solution**:
- Verify 20ms sync pulse detection (20ms ±2ms valid range)
- Check circular buffer logic for 497ms lines
- Increase buffer size if needed

## Comparison with Robot36

| Feature | Robot36 | PD120 |
|---------|---------|-------|
| Resolution | 320×240 | 640×496 |
| Pixels | 76,800 | 317,440 (4.1× more) |
| Line Time | 150ms | 497ms (3.3× longer) |
| Total Time | 36s | 246s (6.8× longer) |
| Sync Pulse | 9ms | 20ms |
| Color Encoding | Interlaced YUV | Sequential RGB |
| Complexity | Higher (interlacing) | Lower (per-line) |
| Use Case | Fast QSOs | Quality images, ISS |

## Testing Recommendations

1. **Sync Detection Test**: Verify 20ms pulses at 1200 Hz are detected
2. **Timing Test**: Confirm ~497ms between sync pulses
3. **Channel Separation Test**: Verify Y, R-Y, B-Y channels are correctly parsed
4. **Color Test**: Use test patterns with known colors (primary colors, grayscale)
5. **Resolution Test**: Verify all 640×496 pixels are decoded
6. **Line Count Test**: Ensure all 496 lines are processed

## ISS SSTV Events

PD120 is the most common mode used by the International Space Station for SSTV events:

- **Frequency**: 145.800 MHz FM (downlink)
- **Typical duration**: 2-3 minute passes
- **Repeat cycle**: Usually transmitted repeatedly over several days
- **Quality**: Good with proper antenna and clear pass

**Decoding Tips:**
- Use directional antenna (Yagi or helical)
- Track ISS pass with satellite tracking software
- Start decoder before pass begins
- Record audio as backup
- Multiple passes may be needed for complete image

## References

- PD mode specification: SSTV Handbook (Amateur Radio community)
- Color space: ITU-R BT.601 standard
- ISS SSTV: ARISS (Amateur Radio on ISS) documentation
- DSP techniques: Lyons, "Understanding Digital Signal Processing"
- Original Robot36 implementation: [github.com/xdsopl/robot36](https://github.com/xdsopl/robot36)
